<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lise Hist√≥rica da Gasolina (1980-2025)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 60vh;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 500px;
            }
        }
        .kpi-value {
            font-size: 2.5rem;
            line-height: 1.1;
        }
        .loading-animation {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #005F73;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .history-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .history-item:hover {
            background-color: #e0f7fa; /* Light cyan */
        }
    </style>
</head>
<body class="bg-[#F0F4F8]">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-[#005F73] mb-2">Gasolina: 45 Anos de Influ√™ncias no Brasil</h1>
            <p class="text-lg md:text-xl text-[#0A9396]">O papel do D√≥lar, Petr√≥leo Brent e Impostos no pre√ßo do combust√≠vel (1980-2025).</p>
        </header>

        <main class="space-y-12">

            <!-- Se√ß√£o de Gr√°fico Hist√≥rico -->
            <section class="bg-white rounded-lg shadow-lg p-6 md:p-8">
                <h2 class="text-2xl font-bold text-[#005F73] mb-4 text-center">A Batalha das Vari√°veis: C√¢mbio, Commodity e Fiscal</h2>
                <p class="text-center text-gray-600 mb-6 max-w-3xl mx-auto">
                    Este gr√°fico de 45 anos mostra a complexa rela√ß√£o entre o pre√ßo internacional do petr√≥leo (d√≥lar, amarelo), a cota√ß√£o do c√¢mbio (d√≥lar, verde) e o pre√ßo final da gasolina (azul).
                </p>
                <div class="chart-container">
                    <canvas id="trendsChart"></canvas>
                </div>
            </section>

            <!-- Se√ß√£o do Simulador de Pre√ßos (Gemini API) + Hist√≥rico (Firestore) -->
            <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <!-- Coluna de Hist√≥rico de Simula√ß√µes (Agora P√∫blico) -->
                <div class="lg:col-span-1 bg-white rounded-lg shadow-xl p-6 md:p-8 border-l-4 border-[#0A9396] order-2 lg:order-1">
                    <h2 class="text-xl font-bold text-[#005F73] mb-4 flex items-center">
                        Simula√ß√µes da Comunidade üåé
                    </h2>
                    <div id="authStatus" class="text-sm text-gray-500 mb-4 italic">
                        Carregando status de autentica√ß√£o...
                    </div>
                    <div id="simulationsList" class="space-y-2 max-h-[500px] overflow-y-auto">
                        <p class="text-center text-gray-400 py-4" id="noHistoryMessage">
                            Nenhuma simula√ß√£o salva ainda.
                        </p>
                        <!-- Simula√ß√µes ser√£o injetadas aqui -->
                    </div>
                </div>

                <!-- Coluna do Simulador Principal -->
                <div class="lg:col-span-2 bg-[#D8F0F8] rounded-lg shadow-xl p-6 md:p-8 border-l-4 border-[#005F73] order-1 lg:order-2">
                    <h2 class="text-2xl font-bold text-[#005F73] mb-4 flex items-center">
                        Simulador Gemini de Pre√ßo Futuro ‚ú®
                    </h2>
                    <p class="text-gray-700 mb-6">
                        Projete o pre√ßo da gasolina ao consumidor final (R$/Litro) inserindo seus pr√≥prios cen√°rios. Seu cen√°rio ser√° salvo publicamente.
                    </p>
                    
                    <div class="flex flex-col md:flex-row gap-4 mb-6 items-end">
                        <div class="flex-1 w-full">
                            <label for="dollarInput" class="block text-sm font-medium text-gray-700">Cota√ß√£o D√≥lar (R$/US$)</label>
                            <input type="number" step="0.01" id="dollarInput" value="5.35" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5" placeholder="Ex: 5.35">
                        </div>
                        <div class="flex-1 w-full">
                            <label for="brentInput" class="block text-sm font-medium text-gray-700">Petr√≥leo Brent (US$/Barril)</label>
                            <input type="number" step="1" id="brentInput" value="69" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5" placeholder="Ex: 69">
                        </div>
                        <button id="simulateButton" onclick="simulatePrice()" class="w-full md:w-auto px-6 py-2.5 bg-[#0A9396] text-white font-bold rounded-lg hover:bg-[#005F73] transition duration-200 flex items-center justify-center">
                            <span id="buttonText">Simular Pre√ßo Final ‚ú®</span>
                            <div id="loadingIndicator" class="loading-animation hidden ml-2"></div>
                        </button>
                    </div>

                    <!-- √Årea de Resultados -->
                    <div id="resultArea" class="mt-6 p-4 bg-white rounded-lg shadow-md border-l-4 border-gray-400 hidden">
                        <p class="text-lg font-bold text-[#005F73] mb-2">An√°lise de Cen√°rio:</p>
                        <div id="geminiOutput" class="text-gray-700"></div>
                        <div id="sources" class="text-xs text-gray-500 mt-4 italic"></div>
                    </div>

                </div>
            </section>
            
            <!-- Outras Se√ß√µes Mantidas (KPIs, Composi√ß√£o, Descolamentos) -->
            <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-center">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="font-bold text-[#CA6702] text-lg">Pico Hist√≥rico Brent</h3>
                    <p class="kpi-value font-bold text-[#BB3E03]">$147</p>
                    <p class="text-gray-600">Alcan√ßado brevemente em 2008.</p>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="font-bold text-[#CA6702] text-lg">Era do C√¢mbio Fixo</h3>
                    <p class="kpi-value font-bold text-[#BB3E03]">R$ 0,85</p>
                    <p class="text-gray-600">Cota√ß√£o do D√≥lar no in√≠cio do Plano Real (1994).</p>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="font-bold text-[#CA6702] text-lg">Gasolina Mais Barata (Real)</h3>
                    <p class="kpi-value font-bold text-[#BB3E03]">R$ 1,05</p>
                    <p class="text-gray-600">Pre√ßo ajustado em 1994, o menor em 45 anos.</p>
                </div>
                 <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="font-bold text-[#CA6702] text-lg">Maior Carga Tribut√°ria</h3>
                    <p class="kpi-value font-bold text-[#BB3E03]">48%</p>
                    <p class="text-gray-600">Percentual m√©dio de impostos no pre√ßo final.</p>
                </div>
            </section>
            
            <section class="grid grid-cols-1 md:grid-cols-5 gap-8 items-center">
                <div class="md:col-span-3 bg-white rounded-lg shadow-lg p-6 md:p-8">
                    <h2 class="text-2xl font-bold text-[#005F73] mb-4">Composi√ß√£o Estrutural do Pre√ßo</h2>
                    <p class="text-gray-600 mb-6">
                        A estrutura de custo √© dominada pelo insumo (Petrobras, D√≥lar e Etanol) e pela interven√ß√£o estatal (Impostos).
                    </p>
                    <div class="space-y-4">
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-[#005F73] flex items-center justify-center text-white font-bold mr-4">1</div>
                            <span class="font-semibold text-gray-700">Petr√≥leo Brent + C√¢mbio (D√≥lar)</span>
                        </div>
                        <div class="ml-4 pl-5 border-l-2 border-dashed border-[#94D2BD]">
                            <div class="text-4xl text-[#94D2BD] -ml-9 mt-1 mb-1">‚Üì</div>
                        </div>
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-[#0A9396] flex items-center justify-center text-white font-bold mr-4">2</div>
                            <span class="font-semibold text-gray-700">Pre√ßo de Realiza√ß√£o da Petrobras (Refino)</span>
                        </div>
                         <div class="ml-4 pl-5 border-l-2 border-dashed border-[#94D2BD]">
                            <div class="text-4xl text-[#94D2BD] -ml-9 mt-1 mb-1">‚Üì</div>
                        </div>
                        <div class="flex items-center">
                             <div class="w-8 h-8 rounded-full bg-[#94D2BD] flex items-center justify-center text-black font-bold mr-4">3</div>
                            <span class="font-semibold text-gray-700">Adi√ß√£o de Biocombust√≠vel (Etanol Anidro)</span>
                        </div>
                         <div class="ml-4 pl-5 border-l-2 border-dashed border-[#94D2BD]">
                            <div class="text-4xl text-[#94D2BD] -ml-9 mt-1 mb-1">‚Üì</div>
                        </div>
                         <div class="flex items-center">
                             <div class="w-8 h-8 rounded-full bg-[#BB3E03] flex items-center justify-center text-white font-bold mr-4">4</div>
                            <span class="font-semibold text-gray-700 font-bold">Carga Tribut√°ria Total (41% M√©dia)</span>
                        </div>
                         <div class="ml-4 pl-5 border-l-2 border-dashed border-[#94D2BD]">
                            <div class="text-4xl text-[#94D2BD] -ml-9 mt-1 mb-1">‚Üì</div>
                        </div>
                         <div class="flex items-center">
                             <div class="w-8 h-8 rounded-full bg-[#EE9B00] flex items-center justify-center text-white font-bold mr-4">5</div>
                            <span class="font-semibold text-gray-700">Custos de Distribui√ß√£o e Revenda</span>
                        </div>
                    </div>
                </div>
                <div class="md:col-span-2">
                    <div class="chart-container h-[400px] max-h-[400px]">
                         <canvas id="compositionChart"></canvas>
                    </div>
                    <p class="text-center font-semibold text-gray-700 mt-2">Composi√ß√£o M√©dia do Pre√ßo Final (Atual)</p>
                </div>
            </section>
            
            <section>
                <h2 class="text-2xl font-bold text-[#005F73] mb-6 text-center">Descolamentos Hist√≥ricos (1980-2025)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="font-bold text-xl text-[#AE2012] mb-2">1980-1994: Controle e Crise</h3>
                        <p class="text-gray-600">Pre√ßo determinado por decretos. Subs√≠dios do governo mascaravam o custo real em um per√≠odo de hiperinfla√ß√£o.</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="font-bold text-xl text-[#AE2012] mb-2">1994: Plano Real</h3>
                        <p class="text-gray-600">A vincula√ß√£o cambial ($1=R$1) estabilizou a gasolina a um pre√ßo baixo, mas o controle cambial levou ao esgotamento em poucos anos.</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="font-bold text-xl text-[#AE2012] mb-2">2008: O Pico do Brent</h3>
                        <p class="text-gray-600">Petr√≥leo atingiu $147. O pre√ßo no Brasil foi segurado gra√ßas a subs√≠dios da Petrobras e um D√≥lar baixo (R$ 1,85).</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="font-bold text-xl text-[#AE2012] mb-2">2022: Guerra e Desonera√ß√£o</h3>
                        <p class="text-gray-600">Com D√≥lar e Brent altos, o pre√ßo despencou devido √† interven√ß√£o fiscal (redu√ß√£o dr√°stica de impostos), provando o poder da alavanca tribut√°ria.</p>
                    </div>
                </div>
            </section>

        </main>
        
        <footer class="text-center mt-12 pt-8 border-t border-gray-300">
            <p class="text-gray-500">An√°lise baseada em dados hist√≥ricos (1980-2025). O Simulador Gemini utiliza o modelo gemini-2.5-flash-preview-05-20 com Google Search para grounding e o Firebase Firestore para persist√™ncia de dados.</p>
        </footer>

    </div>

    <script type="module">
        // Importa√ß√µes do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, orderBy, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Vari√°veis Globais para Firebase
        let app;
        let db;
        let auth;
        let userId = 'default-user'; // Fallback
        let appId = 'default-app-id';

        // Constantes para caminhos do Firestore
        const SIMULATIONS_COLLECTION = 'gas_simulations'; 

        // FUN√á√ÉO DETERMIN√çSTICA CALIBRADA
        function calculateGasPrice(dollar, brent) {
            const litersPerBarrel = 159;
            const aggregateCostMultiplier = 2.67; 
            const crudeCostPerLiter = (brent / litersPerBarrel) * dollar; 
            const finalPrice = crudeCostPerLiter * aggregateCostMultiplier;
            return parseFloat(finalPrice.toFixed(2));
        }

        // Fun√ß√£o de Inicializa√ß√£o do Firebase e Autentica√ß√£o
        async function initFirebase() {
            try {
                // 1. Configura√ß√£o e Inicializa√ß√£o
                // As configura√ß√µes do Firebase foram inseridas diretamente aqui.
                const firebaseConfig = {
                    apiKey: "AIzaSyBlqWsbSwUlXOvQfrcQLNYrZMBPFaUOwos",
                    authDomain: "gasolina-8d5b1.firebaseapp.com",
                    projectId: "gasolina-8d5b1",
                    storageBucket: "gasolina-8d5b1.firebasestorage.app",
                    messagingSenderId: "1084395544297",
                    appId: "1:1084395544297:web:5d057ed8156107db16da78",
                    measurementId: "G-125HLL4LH8"
                };

                appId = firebaseConfig.appId; // Garante que o appId global seja definido a partir da configura√ß√£o

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                // Adiciona log level para debug de permiss√µes
                setLogLevel('debug');
                
                auth = getAuth(app);
                
                const authStatusElement = document.getElementById('authStatus');
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                // 2. Autentica√ß√£o Direta (S√≠ncrona)
                if (token) {
                    await signInWithCustomToken(auth, token);
                    userId = auth.currentUser.uid;
                    authStatusElement.innerHTML = `Status: Autenticado. ID do Usu√°rio: <span class="font-semibold">${userId.substring(0, 8)}...</span>`;
                } else {
                    const userCredential = await signInAnonymously(auth);
                    userId = userCredential.user.uid;
                    authStatusElement.innerHTML = `Status: An√¥nimo. ID do Usu√°rio: <span class="font-semibold">${userId.substring(0, 8)}...</span>`;
                }
                
                // 3. Carrega Simula√ß√µes AP√ìS a autentica√ß√£o estar completa
                loadSimulations();

            } catch (error) {
                console.error("Erro fatal na inicializa√ß√£o ou autentica√ß√£o do Firebase. O Project ID ainda pode estar faltando ou o token de autentica√ß√£o est√° inv√°lido.", error);
                document.getElementById('authStatus').textContent = 'Erro fatal ao conectar. Recarregue a p√°gina.';
            }
        }
        
        // Fun√ß√£o para obter a refer√™ncia da cole√ß√£o p√∫blica (Compartilhada)
        function getSimulationsCollectionRef() {
            if (!db || !userId) {
                console.error("Firestore ou User ID n√£o est√° pronto.");
                return null;
            }
            // Caminho PUBLICO: /artifacts/{appId}/public/data/gas_simulations
            return collection(db, `artifacts/${appId}/public/data/${SIMULATIONS_COLLECTION}`);
        }

        // Fun√ß√£o para carregar simula√ß√µes em tempo real
        function loadSimulations() {
            const simulationsRef = getSimulationsCollectionRef();
            const listElement = document.getElementById('simulationsList');
            const noHistoryMessage = document.getElementById('noHistoryMessage');
            
            if (!simulationsRef) return;

            // Ordena os resultados localmente ap√≥s a busca (usando timestamp)
            onSnapshot(simulationsRef, (snapshot) => {
                const simulations = [];
                snapshot.forEach(doc => {
                    simulations.push({ id: doc.id, ...doc.data() });
                });

                // Ordena os dados em mem√≥ria (do mais recente para o mais antigo)
                simulations.sort((a, b) => b.timestamp - a.timestamp);

                listElement.innerHTML = '';
                noHistoryMessage.classList.add('hidden');

                if (simulations.length === 0) {
                    noHistoryMessage.classList.remove('hidden');
                    return;
                }

                simulations.forEach(sim => {
                    const date = new Date(sim.timestamp).toLocaleDateString('pt-BR', {
                        day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'
                    });
                    
                    const creatorDisplay = sim.creatorId ? sim.creatorId.substring(0, 8) + '...' : 'An√¥nimo';
                    
                    const listItem = document.createElement('div');
                    listItem.className = 'history-item p-3 rounded-lg border border-gray-200 text-sm';
                    listItem.innerHTML = `
                        <div class="font-bold text-[#005F73]">R$${sim.dollar.toFixed(2)} | $${sim.brent}</div>
                        <div class="text-gray-500">${date} - Criado por: <span class="font-semibold">${creatorDisplay}</span></div>
                    `;
                    listItem.onclick = () => displaySimulation(sim);
                    listElement.appendChild(listItem);
                });
            }, (error) => {
                console.error("Erro ao carregar simula√ß√µes:", error);
                // Melhorando a mensagem de erro para o usu√°rio final
                let errorMessage = "Erro ao carregar hist√≥rico.";
                if (error.message && (error.message.includes("permission") || error.message.includes("permissions"))) {
                    errorMessage = "Erro de Permiss√£o (Acesso Negado). Tente recarregar a p√°gina.";
                }
                listElement.innerHTML = `<p class="text-red-500">${errorMessage}</p>`;
            });
        }

        // Fun√ß√£o para salvar a simula√ß√£o no Firestore
        async function saveSimulationData(dollar, brent, geminiText, sources) {
            const simulationsRef = getSimulationsCollectionRef();
            if (!simulationsRef) return;

            try {
                await addDoc(simulationsRef, {
                    dollar: parseFloat(dollar),
                    brent: parseInt(brent),
                    geminiText: geminiText,
                    sources: sources,
                    timestamp: Date.now(),
                    creatorId: userId 
                });
            } catch (error) {
                console.error("Erro ao salvar simula√ß√£o no Firestore:", error);
            }
        }

        // Fun√ß√£o para exibir uma simula√ß√£o salva
        function displaySimulation(simData) {
            const resultArea = document.getElementById('resultArea');
            const geminiOutput = document.getElementById('geminiOutput');
            const sourcesDiv = document.getElementById('sources');

            geminiOutput.innerHTML = simData.geminiText.replace(/\*\*(.*?)\*\*/g, '<span class="text-xl font-extrabold text-[#BB3E03]">$1</span>');
            
            if (simData.sources && simData.sources.length > 0) {
                sourcesDiv.innerHTML = 'Fontes de Dados (para grounding): ' + simData.sources.map(s => `<a href="${s.uri}" target="_blank" class="underline hover:text-[#0A9396]">${s.title}</a>`).join(' | ');
            } else {
                sourcesDiv.innerHTML = '';
            }

            // Atualiza inputs para refletir o cen√°rio carregado
            document.getElementById('dollarInput').value = simData.dollar.toFixed(2);
            document.getElementById('brentInput').value = simData.brent;

            resultArea.classList.remove('hidden');
        }

        // Fun√ß√£o utilit√°ria para lidar com o retry de chamadas de API
        async function exponentialBackoffFetch(url, options, maxRetries = 5, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;

                    if ((response.status === 429 || response.status === 401 || response.status >= 500) && i < maxRetries - 1) { 
                        console.warn(`Tentativa ${i + 1} falhou com status ${response.status}. Tentando novamente em ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                    } else {
                        const errorBody = await response.text();
                        const errorDetails = errorBody.substring(0, 150); 
                        throw new Error(`API retornou status ${response.status}: ${response.statusText}. Detalhes: ${errorDetails}`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                        console.error("Erro fatal ap√≥s todas as tentativas.", error);
                        throw error;
                    }
                    console.warn(`Tentativa ${i + 1} falhou com erro de rede. Tentando novamente em ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
            throw new Error("Falha na chamada da API ap√≥s o m√°ximo de tentativas.");
        }

        window.simulatePrice = async function() {
            const dollar = document.getElementById('dollarInput').value;
            const brent = document.getElementById('brentInput').value;
            const resultArea = document.getElementById('resultArea');
            const geminiOutput = document.getElementById('geminiOutput');
            const sourcesDiv = document.getElementById('sources');
            const simulateButton = document.getElementById('simulateButton');
            const buttonText = document.getElementById('buttonText');
            const loadingIndicator = document.getElementById('loadingIndicator');

            if (!dollar || !brent || isNaN(parseFloat(dollar)) || isNaN(parseInt(brent))) {
                geminiOutput.innerHTML = '<span class="text-red-600 font-bold">Por favor, insira valores v√°lidos.</span>';
                resultArea.classList.remove('hidden');
                return;
            }
            
            // 1. CALCULA O PRE√áO DE FORMA DETERMIN√çSTICA NO JAVASCRIPT
            const estimatedPrice = calculateGasPrice(parseFloat(dollar), parseInt(brent));
            
            // UI feedback: loading state
            simulateButton.disabled = true;
            buttonText.textContent = 'Simulando...';
            loadingIndicator.classList.remove('hidden');
            resultArea.classList.add('hidden');
            geminiOutput.innerHTML = '';
            sourcesDiv.innerHTML = '';

            try {
                // O Gemini agora JUSTIFICA este pre√ßo calculado:
                const systemPrompt = "Aja como um analista financeiro brasileiro especializado em commodities e energia. Use a estrutura de composi√ß√£o de pre√ßo m√©dia (aprox. 41% impostos, 34% Petrobras/Refino, 15% Etanol, 10% Distribui√ß√£o) para **justificar o pre√ßo final fornecido**. Apresente a estimativa clara do pre√ßo final formatada como **Gasolina Estimada: R$ X,XX/Litro** seguida pela justificativa econ√¥mica em um √∫nico par√°grafo conciso. A justificativa deve citar explicitamente a influ√™ncia do c√¢mbio, do Brent e da carga tribut√°ria. Use a v√≠rgula como separador decimal no pre√ßo.";
                
                const userQuery = `O pre√ßo final da gasolina ao consumidor (R$/Litro) √© de R$${estimatedPrice.toFixed(2).replace('.', ',')}. Justifique este pre√ßo, considerando que o D√≥lar est√° em R$${dollar} e o Petr√≥leo Brent est√° em $${brent}. Use a estrutura de custos brasileira e as pol√≠ticas fiscais atuais (PIS/Cofins, ICMS) para sua an√°lise.`;
                
                // Chama o endpoint backend seguro (Vercel /api/analise) em vez de expor a API key
                // Enviamos apenas os dados necess√°rios: dollar, brent e estimatedPrice
                const response = await exponentialBackoffFetch('/api/analise', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dollar: parseFloat(dollar), brent: parseInt(brent), estimatedPrice })
                });

                const result = await response.json();

                // Esperamos que o backend retorne { analysis: string, sources?: Array }.
                const analysisText = result.analysis;
                const sources = result.sources || [];

                if (analysisText && typeof analysisText === 'string') {
                    // Substitu√≠mos a se√ß√£o estimada (caso o backend n√£o a tenha formatado)
                    const fixedOutputText = analysisText.replace(/Gasolina Estimada: R\$ [0-9,.]+?\/Litro/i, `Gasolina Estimada: R$ ${estimatedPrice.toFixed(2).replace('.', ',')}/Litro`);

                    geminiOutput.innerHTML = fixedOutputText.replace(/\*\*(.*?)\*\*/g, '<span class="text-xl font-extrabold text-[#BB3E03]">$1</span>');
                    if (sources.length > 0) {
                        sourcesDiv.innerHTML = 'Fontes de Dados (para grounding): ' + sources.map(s => `<a href="${s.uri}" target="_blank" class="underline hover:text-[#0A9396]">${s.title}</a>`).join(' | ');
                    } else {
                        sourcesDiv.innerHTML = 'Fontes de Dados (para grounding): Nenhuma fonte externa utilizada para esta an√°lise.';
                    }

                    // Salva no Firestore
                    await saveSimulationData(dollar, brent, fixedOutputText, sources);
                } else {
                    geminiOutput.innerHTML = '<span class="text-red-600 font-bold">Erro: N√£o foi poss√≠vel obter a an√°lise. Tente novamente.</span>';
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                geminiOutput.innerHTML = `<span class="text-red-600 font-bold">Erro na comunica√ß√£o com a API: ${error.message}.</span>`;
            } finally {
                // UI feedback: reset state
                simulateButton.disabled = false;
                buttonText.textContent = 'Simular Pre√ßo Final ‚ú®';
                loadingIndicator.classList.add('hidden');
                resultArea.classList.remove('hidden');
            }
        }

        // --- Chart Initialization e Call to Firebase Init ---
        document.addEventListener('DOMContentLoaded', function () {
            
            initFirebase(); // Inicia o Firebase e a autentica√ß√£o

            // Gr√°fico Hist√≥rico
            const labels = ['1980', '1985', '1990', '1994 (Real)', '1998', '2001', '2004', '2008', '2011', '2014', '2016', '2018', '2020', '2022', '2025'];
            const gasolinePrices = [2.50, 2.30, 2.10, 1.05, 1.85, 2.35, 2.50, 2.55, 2.70, 2.90, 3.67, 4.28, 4.40, 6.30, 5.85];
            const oilPrices = [37, 27, 20, 17, 14, 25, 38, 97, 111, 99, 45, 71, 42, 101, 88];
            const dollarRates = [1.00, 1.00, 1.00, 0.85, 1.18, 2.32, 2.93, 1.85, 1.67, 2.35, 3.49, 3.65, 5.39, 5.16, 5.25];
            const taxPrices = [0.40, 0.45, 0.50, 0.20, 0.45, 0.70, 0.90, 1.05, 1.15, 1.20, 1.65, 1.95, 2.25, 1.30, 2.40]; 

            const trendsCtx = document.getElementById('trendsChart').getContext('2d');
            new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Gasolina (R$ / Litro - Ajustado)', data: gasolinePrices, borderColor: '#005F73', backgroundColor: '#005F73', yAxisID: 'yBRL', tension: 0.3, borderWidth: 4 },
                        { label: 'Total Impostos (R$ / Litro)', data: taxPrices, borderColor: '#AE2012', backgroundColor: '#AE2012', yAxisID: 'yBRL', tension: 0.3, borderWidth: 2, borderDash: [2, 2] },
                        { label: 'D√≥lar (R$ / US$)', data: dollarRates, borderColor: '#94D2BD', backgroundColor: '#94D2BD', yAxisID: 'yBRL', tension: 0.3, borderWidth: 2, borderDash: [5, 5] },
                        { label: 'Petr√≥leo Brent ($ / Barril)', data: oilPrices, borderColor: '#EE9B00', backgroundColor: '#EE9B00', yAxisID: 'yUSD', tension: 0.3, borderWidth: 2 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    scales: {
                        yBRL: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Valor em Reais (R$)' }, grid: { drawOnChartArea: false }, min: 0, max: 7 },
                        yUSD: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Valor em D√≥lares ($)' }, grid: { drawOnChartArea: true, color: '#E0E0E0' }, min: 0, max: 120 }
                    }
                }
            });
            
            // Gr√°fico de Composi√ß√£o
            const compositionCtx = document.getElementById('compositionChart').getContext('2d');
            new Chart(compositionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Realiza√ß√£o Petrobras (34%)', ['Total de Impostos', '(Federais + Estaduais) (41%)'], 'Custo Etanol Anidro (15%)', 'Distribui√ß√£o e Revenda (10%)'],
                    datasets: [{
                        data: [34, 41, 15, 10], 
                        backgroundColor: ['#005F73', '#BB3E03', '#94D2BD', '#EE9B00'], 
                        borderColor: '#F0F4F8',
                        borderWidth: 4,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 15, padding: 15 } } }
                }
            });

        });
    </script>

</body>
</html>
